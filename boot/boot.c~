#include <efi.h>
#include <efilib.h>

UINTN MemoryMapSize = 0;
EFI_MEMORY_DESCRIPTOR *MemoryMap = 0;
UINTN MapKey;
UINTN DescriptorSize;
UINT32 DescriptorVersion;

#define PRINT(String) ST->ConOut->OutputString(ST->ConOut, (String))

VOID *BootAllocatePool(UINTN Size) {
	EFI_STATUS Status;
	VOID *Result;

	Status = gBS->AllocatePool(EfiLoaderData, Size, &Result);
	if(EFI_ERROR(Status)) {
		PRINT(L"Failed to allocate pool.\r\n");
		return(0);
	}

	return(Result);
}

EFI_STATUS EfiMain(EFI_HANDLE ImageHandle, EFI_SYSTEM_TABLE *SystemTable) {
	EFI_STATUS Status;
	EFI_INPUT_KEY Key;

	ST = SystemTable;
	gBS = ST->BootServices;

	Status = ST->ConOut->ClearScreen(ST->ConOut);
	if(EFI_ERROR(Status)) {
		return(Status);
	}

	Status = ST->ConIn->Reset(ST->ConIn, FALSE);
	if(EFI_ERROR(Status)) {
		return(Status);
	}

	// -----Memory Map-----
	Status = gBS->GetMemoryMap(
			&MemoryMapSize,
			MemoryMap, &MapKey,
			&DescriptorSize, &DescriptorVersion);
	if(Status != EFI_BUFFER_TOO_SMALL) {
		PRINT(L"Memory map invalid parameter(s).\r\n");
		return(Status);
	}

	MemoryMapSize += 2 * DescriptorSize;
	MemoryMap = BootAllocatePool(MemoryMapSize);

	Status = gBS->GetMemoryMap(
			&MemoryMapSize,
			MemoryMap, &MapKey,
			&DescriptorSize, &DescriptorVersion);
	if(Status == EFI_BUFFER_TOO_SMALL) {
		PRINT(L"Failed to get memory map.\r\n");
		gBS->FreePool(MemoryMap);
		return(Status);
	}

	while((Status = ST->ConIn->ReadKeyStroke(ST->ConIn, &Key)) == EFI_NOT_READY);
	ST->RuntimeServices->ResetSystem(EfiResetShutdown, EFI_SUCCESS, 0, 0);
	return(Status);
}
